#!/usr/bin/env zsh
set -e

# -----------------------------
# Flutter Wrapper
# -----------------------------
# GitHub: https://github.com/badrat-in/flutter-wrapper
# -----------------------------

FLUTTER_BIN="/Applications/flutter/bin/flutter"
FLUTTERFLOW_BIN="$HOME/Library/Application Support/io.flutterflow.prod.mac/flutter/bin/flutter"

# Default engine (can be overridden via env)
if [[ -f ~/.flutter_wrapper_engine ]]; then
    ENGINE=$(cat ~/.flutter_wrapper_engine)
else
    ENGINE="flutter"  # default
fi

# Decide which real Flutter binary based on engine
REAL_FLUTTER=$([[ "$ENGINE" == "flutterflow" ]] && echo "$FLUTTERFLOW_BIN" || echo "$FLUTTER_BIN")

# -----------------------------
# Helper Commands
# -----------------------------
case "$1" in
  use)
    echo "$2" > ~/.flutter_wrapper_engine
    echo "Using Flutter version: $2"
    exit 0
    ;;
  icons)
    shift
    zsh "$(dirname $0)/../scripts/generate-icons.zsh" "$@"
    exit 0
    ;;
  resize)
    shift
    zsh "$(dirname $0)/../scripts/resize-screenshots.zsh" "$@"
    exit 0
    ;;
  build)
    # Auto-versioning
    PUBSPEC="pubspec.yaml"
    PLATFORM=$2
    shift 2

    if [[ -f $PUBSPEC ]]; then
      # Extract version using regex
      VERSION_NAME=$(grep -Eo 'version:\s*([0-9]+\.[0-9]+\.[0-9]+)' "$PUBSPEC" | head -n1 | awk '{print $2}')
    else
      VERSION_NAME="0.0.1"
    fi

    BUILD_NUMBER=$(git rev-list --count HEAD)

    if [[ -f $PUBSPEC ]]; then
      sed -i '' "s/^version:.*/version: ${VERSION_NAME}+${BUILD_NUMBER}/" "$PUBSPEC"
      echo "[INFO] Updated pubspec.yaml â†’ ${VERSION_NAME}+${BUILD_NUMBER}"
    fi

    echo "[INFO] Building Flutter app for $PLATFORM"
    "$REAL_FLUTTER" build "$PLATFORM" "$@"
    ;;
  *)
    # All other flutter commands
    echo "[INFO] Running command $1"
    "$REAL_FLUTTER" "$@"
    ;;
esac

# Return the exit code of the last command executed
EXIT_CODE=$?
return $EXIT_CODE
